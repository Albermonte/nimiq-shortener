<!doctype html>
<html lang="en">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<link rel="stylesheet" href="scripts/bootstrap.css" />



<link rel="stylesheet" href="scripts/fontawesome-all.min.css" />
<link rel="stylesheet" href="scripts/fa-regular.min.css" />
<link rel="stylesheet" href="styles/main.css">
<title>SushiPool webminer</title>
<script src="scripts/nimiq.js"></script>
<script>
        function updateT() {
            let threads = document.getElementById('threads').value;
            document.getElementById('thre').innerText = threads;
        }
        function _onConsensusEstablished() {

            document.getElementById('threads').setAttribute('max', navigator.hardwareConcurrency || 8 );

            document.getElementById('message').innerText = 'Consensus established.';
            document.getElementById('height').innerText = $.blockchain.height;

            document.getElementById('form').style = "";

            _updateBalance();

            // recheck balance on potential balance change
            $.blockchain.on('head-changed', _updateBalance);
        }

        function _updateBalance() {
            if ($.address) {
                $.accounts.get($.address).then(account => _onBalanceChanged(account));
            }
        }

        function _onBalanceChanged(account) {
            account = account || Nimiq.BasicAccount.INITIAL;
            console.log(`New balance of ${$.address} is ${account.balance}.`);
            document.getElementById('balance').innerText = Nimiq.Policy.satoshisToCoins(account.balance).toFixed(5);
        }

        function _onHeadChanged() {
            const height = $.blockchain.height;
            console.log(`Now at height ${height}.`);
            document.getElementById('height').innerText = height;
        }

        function _onPeersChanged() {
            console.log(`Now connected to ${$.network.peerCount} peers.`);
            document.getElementById('peers').innerText = $.network.peerCount;
        }

        function _onPoolConnectionChanged(state) {
            if (state === Nimiq.BasePoolMiner.ConnectionState.CONNECTING) {
                document.getElementById('pool').innerText = "Connect...";
            }
            if (state === Nimiq.BasePoolMiner.ConnectionState.CONNECTED) {
                document.getElementById('pool').innerText = "Connected to pool";
                $.miner.startWork();
            }
            if (state === Nimiq.BasePoolMiner.ConnectionState.CLOSED) {
                document.getElementById('pool').innerText = "Connection closed";
            }
            console.log(`Pool connection state ${state}`);
        }

        function _onHashrateChanged(rate) {
            document.getElementById('hashrate').innerText = rate + " h/s";
        }


        Nimiq.init(async () => {
            Nimiq.GenesisConfig.main();
            document.getElementById('message').innerText = 'Nimiq loaded. Connecting and establishing consensus.';

            const $ = {};
            window.$ = $;

            $.consensus = await Nimiq.Consensus.light();
            $.blockchain = $.consensus.blockchain;
            $.accounts = $.blockchain.accounts;
            $.mempool = $.consensus.mempool;
            $.network = $.consensus.network;

            $.consensus.on('established', () => _onConsensusEstablished());
            $.consensus.on('lost', () => console.error('Consensus lost'));

            $.blockchain.on('head-changed', () => _onHeadChanged());
            $.network.on('peers-changed', () => _onPeersChanged());

            $.network.connect();
        }, function (code) {
            switch (code) {
                case Nimiq.ERR_WAIT:
//                    alert('Error: Already open in another tab or window.');
                    break;
                case Nimiq.ERR_UNSUPPORTED:
                    alert('Error: Browser not supported');
                    break;
                default:
                    alert('Error: Nimiq initialization error');
                    break;
            }
        });

        let mining = false;

        function toggleMining1() {
            try {
                if (!mining) {
                    $.address = Nimiq.Address.fromUserFriendlyAddress(document.getElementById('address').value);

                    mining = true;
                    document.getElementById('toggleMining').innerHTML = "Stop Mining";
                    let threads = document.getElementById('threads').value;

                    $.miner = new Nimiq.SmartPoolMiner($.blockchain, $.accounts, $.mempool, $.network.time, $.address,
                        Nimiq.BasePoolMiner.generateDeviceId($.network.config));
                    $.miner.threads = threads;
                    $.miner.connect('eu.sushipool.com', 443);
                    $.miner.on('connection-state', _onPoolConnectionChanged);
                    $.miner.on('hashrate-changed', _onHashrateChanged);
                    _updateBalance();

                    document.getElementById('threads').disabled = "disabled";
                    document.getElementById('address').disabled = "disabled";
                } else {
                    mining = false;
                    document.getElementById('toggleMining').innerHTML = "Start Mining";
                    $.miner.stopWork();
                    $.miner.disconnect();

                    document.getElementById('threads').disabled = false;
                    document.getElementById('address').disabled = false;
                }
            } catch (e) {
                alert(e);
            }
            //$.miner.startWork();
        }

    </script>
</head>
<body>
<nav class="navbar  navbar-expand-lg navbar-light bg-light">
<a class="navbar-brand" href="javascript:history.back()" style="color: #fff;">Go back to SushiPool</a>
</nav>
<div class="container">
<div class="row">
<div class="col-xs-12 block">
<div class="block-title">
SushiPool Webminer
</div>
<div class="block-content">
<p>Status: <span id="message">Loading Nimiq.</span></p>
<p>Current block: <span id="height"><em>loading</em></span></p>
<p>Current number of peers: <span id="peers"><em>loading</em></span></p>
<hr>
<form id="form" style="display: none" onsubmit="return false;">
<div class="form-group">
<label>Address</label>
<input id="address" class="form-control" />
</div>
<div class="form-group">
<label>Threads: <span id="thre">3</span></label>
<input type="range" min="1" max="8" id="threads" value="3" onchange="updateT()" />
</div>
<button id="toggleMining" onclick="toggleMining1()" type="button" class="btn btn-primary">
Start Mining
</button>
<br>
<br>
<p>Pool connection: <span id="pool"><em></em></span></p>
<p>Hashrate: <span id="hashrate"><em></em></span></p>
<p>Balance: <span id="balance"><em></em></span></p>
</form>
</div>
</div>
</div>
</div>


<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
</body>
</html>
